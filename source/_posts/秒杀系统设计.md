## 秒杀需要解决的问题

1. 瞬时流量大
2. 恶意刷单
3. 超卖

**限流**：鉴于只有少部分用户能够秒杀成功，所以要限制大部分流量，只允许少部分流量进入服务后端。

**削峰**：对于秒杀系统瞬时的大量用户涌入，所以在抢购开始会有很高的瞬时峰值。实现削峰的常用方法有利用缓存或者消息中间件等技术；

**异步处理**：对于高并发系统，采用异步处理模式可以极大地提高系统并发量，异步处理就是削峰的一种实现方式；

**内存缓存**：秒杀系统最大的瓶颈最终都可能会是数据库的读写，主要体现在的磁盘的I/O，性能会很低，如果能把大部分的业务逻辑都搬到缓存来处理，效率会有极大的提升；



## 系统设计

![未命名文件 (1)](/Users/jieshi/Desktop/未命名文件 (1).png)

## 下单

![未命名文件 (3)](http://assets.processon.com/chart_image/5dedaa3de4b02996f1e40c49.png)

## #减库存方式

### 下单减库存

优势：用户体验最好。下单减库存是最简单的减库存方式，也是控制最精确的一种。下单时可以直接通过数据库事务机制控制商品库存，所以一定不会出现已下单却付不了款的情况。

劣势：可能卖不出去。正常情况下，买家下单后付款概率很高，所以不会有太大问题。但有一种场景例外，就是当卖家参加某个促销活动时，竞争对手通过恶意下单的方式将该商品全部下单，导致库存清零，那么这就不能正常售卖了——要知道，恶意下单的人是不会真正付款的，这正是 “下单减库存” 的不足之处。

### 付款减库存

优势：一定实际售卖。“下单减库存” 可能导致恶意下单，从而影响卖家的商品销售， “付款减库存” 由于需要付出真金白银，可以有效避免。

劣势：用户体验较差。用户下单后，不一定会实际付款，假设有 100 件商品，就可能出现 200 人下单成功的情况，因为下单时不会减库存，所以也就可能出现下单成功数远远超过真正库存数的情况，这尤其会发生在大促的热门商品上。如此一来就会导致很多买家下单成功后却付不了款，购物体验自然是比较差的。

### 预扣库存

优势：缓解了以上两种方式的问题。预扣库存实际就是“下单减库存”和 “付款减库存”两种方式的结合，将两次操作进行了前后关联，下单时预扣库存，付款时释放库存。

劣势：并没有彻底解决以上问题。比如针对恶意下单的场景，虽然可以把有效付款时间设置为 10 分钟，但恶意买家完全可以在 10 分钟之后再次下单。





## 系统接口

1. 系统对时接口
2. 查询秒杀商品列表
3. 秒杀商品详情
4. 秒杀接口
5. 下单MQ监听接口
6. 结果查询接口

## 订单超时未支付策略

1. 使用MQ的定时消息/延时消息机制（首选）

   通过监听延时消息检查当前订单是否已经支付，若未支付：释放库存。

2. 使用Redis过期key监听

   通过订阅监听功能对过期订单检查是否已经支付（实际上一般只可能是未支付订单才会到这里）

   >  弊端：

   - 1.后台服务不可用时，如果此时有key失效那么是监听不到的。（解决方法：项目启动时或定时任务补偿处理）
   - 2.redis重启或不可用时，导致业务无法处理。（解决方法：redis集群实现高可用）

3. 定时任务检查

   下单成功后新建一条xx分钟后执行的任务，到达指定时间后进行检查订单时候已支付，若未支付：释放库存





## 秒杀活动配置

动态口令配置

秒杀活动分享

